<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Undertale Dialogue Generator</title>

  <!-- Police pixel art Undertale -->
  <style>
    @font-face {
      font-family: 'Determination Mono';
      src: url('sans.woff2') format('woff2');
      font-weight: normal;
      font-style: normal;
    }
  </style>

  <!-- Styles Undertale Dialogue -->
  <style>
    body {
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
    }

    /* UI de saisie (hors cadre OBS si besoin) */
    #ui {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      font-family: sans-serif;
    }
    #dialogInput {
      font-size: 16px;
      padding: 4px;
      width: 400px;
    }
    #sendBtn {
      font-size: 16px;
      padding: 4px 8px;
      margin-left: 8px;
    }

    /* Boîte de dialogue fixe */
    .undertale-dialogue {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 532px;
        height: 150px;
        background-color: #000;
        border: 4px solid #fff;
        padding: 12px;
        box-sizing: border-box;
        display: none;     /* cachée par défaut */
        flex-direction: row;/* pour que “display: flex” reprenne bien plus tard */
        align-items: center;
        image-rendering: pixelated;
        overflow: hidden;
    }
    .undertale-dialogue,
    .undertale-dialogue img,
    .undertale-dialogue .text {
      image-rendering: pixelated;
    }

    /* Avatar */
    .undertale-dialogue .avatar {
        width: 80px;
        height: auto;
        /* margin-right: 33px; */
        padding-left: 18px;
        padding-bottom: 3px;
    }

    /* Zone de texte pixelisée et word-wrap */
    .undertale-dialogue .text {
        font-family: 'Determination Mono', monospace;
        color: #fff;
        font-size: 28px;
        line-height: 1.2;
        white-space: pre-wrap;
        overflow-wrap: break-word;
        word-break: break-word;
        width: calc(100% - 96px - 16px);
        height: 100%;
        padding-left: 43px;
        padding-top: 18px;
        text-transform: lowercase;
    }
  </style>
</head>
<body>

  <!-- UI pour taper le dialogue -->
  <div id="ui">
    <input id="dialogInput" type="text" placeholder="Écris ton dialogue ici…" />
    <button id="sendBtn">Envoyer</button>
  </div>

  <!-- Boîte Undertale -->
  <div class="undertale-dialogue">
    <img class="avatar" src="sans.png" alt="Sans">
    <div id="textbox" class="text"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script> <!-- si vous voulez aussi recevoir les “dialogue” du serveur -->
  <script>
    const SPEED       = 70;      // ms entre chaque lettre
    const input       = document.getElementById('dialogInput');
    const btn         = document.getElementById('sendBtn');
    const box         = document.getElementById('textbox');
    const container   = document.querySelector('.undertale-dialogue');
    let   hideTimer;             // pour pouvoir clearTimeout()

    function playBeep() {
      const s = new Audio('voice_sans.mp3');
      s.playbackRate = 0.8 + Math.random() * 0.4;
      s.play();
    }

    function showDialogue(text) {
      clearTimeout(hideTimer);         // on annule l’ancien hide si nécessaire
      container.style.display = 'flex';// on affiche la boîte
      box.textContent = '';
      let i = 0;
      function typeChar() {
        if (i < text.length) {
          const char = text[i++];
          box.textContent += char;
          playBeep();
          const delay = [',', '!', '?'].includes(char) ? SPEED * 8 : SPEED;
          setTimeout(typeChar, delay);
        } else {
          // frappe terminée → on cache après 3 s
          hideTimer = setTimeout(() => {
            container.style.display = 'none';
          }, 3000);
        }
      }
      typeChar();
    }

    // si vous voulez envoyer via l’UI locale :
    btn.addEventListener('click', () => {
      const txt = input.value.trim();
      if (!txt) return;
      showDialogue('* ' + txt);
      input.value = '';
      input.focus();
    });
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        btn.click();
        e.preventDefault();
      }
    });

    // si vous voulez aussi recevoir les messages “dialogue” depuis le serveur :
    const socket = io();
    socket.on('dialogue', txt => {
      showDialogue('* ' + txt);
    });
  </script>
</body>
</html>